{"version":3,"file":"domerjs.modern.js","sources":["../../src/router.js","../../src/fetcher.js","../../src/element.js","../../src/updater.js","../../src/helpers.js","../../src/ssr.js"],"sourcesContent":["const routes = []\r\nlet baseUrl = ''\r\n\r\nexport function set (path, element, parent) {\r\n  routes.push({ path, element, parent })\r\n}\r\n\r\nexport function setBaseUrl (newBaseUrl) {\r\n  baseUrl = newBaseUrl\r\n}\r\n\r\nconst matchPath = (p1, p2) => {\r\n  if (Array.isArray(p1)) return p1.indexOf(p2) !== -1\r\n  return p1 === p2\r\n}\r\n\r\nexport function apply () {\r\n  let currentPath = window.location.pathname.replace(baseUrl, '')\r\n  const notFound = routes.every(({ path }) => !matchPath(path, currentPath))\r\n\r\n  routes.forEach((route) => {\r\n    const { path, element, parent = window.document.body } = route\r\n\r\n    if (matchPath(path, currentPath) || (notFound && matchPath(path, ''))) {\r\n      parent.append(element)\r\n    } else if (parent.contains(element)) element.remove()\r\n  })\r\n}\r\n\r\nexport function setRouteEl (el, path) {\r\n  if (el.tagName === 'A') el.href = path\r\n  el.addEventListener('click', (e) => {\r\n    e.preventDefault()\r\n    push(path)\r\n  })\r\n  return el\r\n}\r\n\r\nexport function push (path) {\r\n  const newPath = `${baseUrl}${path}`\r\n\r\n  window.history.pushState({ path: newPath }, '', newPath)\r\n\r\n  // Trigger popstate event to update routes\r\n  //window.dispatchEvent(new Event('popstate'))\r\n  apply()\r\n\r\n  // Scroll to tag if any \r\n  const hashIndex = path.indexOf('#')\r\n  if (hashIndex !== -1) {\r\n    const hash = path.substring(hashIndex + 1)\r\n    const element = window.document.getElementById(hash)\r\n    if (element) window.scrollTo(0, element.offsetTop)\r\n  }\r\n}\r\n\r\nwindow.addEventListener('popstate', () => apply())\r\n","export const cache = window.__cache || []\r\nconst attachedFetch = []\r\n\r\nlet defaultRefresh = 100000\r\n\r\nexport function setOptions (options) {\r\n  if (typeof options.refresh === 'number') defaultRefresh = options.refresh\r\n}\r\n\r\nexport function attach (url, func, refresh = defaultRefresh) {\r\n  attachedFetch.push({ url, func, refresh })\r\n}\r\n\r\nexport function detach (url) {\r\n  const index = attachedFetch.findIndex((x) => x.url === url)\r\n  if (index !== -1) attachedFetch.splice(index, 1)\r\n}\r\n\r\nexport function apply () {\r\n  const fetches = attachedFetch.map(({ url, func, refresh }) => get(url, func, refresh))\r\n  return Promise.all(fetches)\r\n}\r\n\r\nexport function get (url, func, refresh = defaultRefresh) {\r\n  return new Promise((resolve) => {\r\n    const cacheItem = cache.find((c) => c.url === url)\r\n    if (cacheItem && Date.now() - refresh < cacheItem.time) {\r\n      resolve(func(cacheItem.data))\r\n      return\r\n    }\r\n  \r\n    fetch(url).then((res) => {\r\n      res.json().then((data) => {\r\n        if (!cacheItem) cache.push({ url, data, time: Date.now() })\r\n        else {\r\n          cacheItem.data = data\r\n          cacheItem.time = Date.now()\r\n        }\r\n  \r\n        resolve(func(data))\r\n      })\r\n    })\r\n  })\r\n}","import { nanoid } from 'nanoid'\r\nimport * as updater from './updater'\r\n\r\nexport let ids = window.__ssr || []\r\n\r\nlet elIndex = 0\r\nexport function newEl (tagName, options = {}) {\r\n  let el = null\r\n  const { attrs = {}, events = {}, dataset = {}, classList = [], value, html, updateOn, useSSR = true } = options\r\n\r\n  let data = {}\r\n\r\n  if (useSSR && window.isServer) {\r\n    el = window.document.createElement(tagName)\r\n    el.id = nanoid(5)\r\n    ids.push({ id: el.id, i: elIndex })\r\n  } else {\r\n    const item = ids.find(({ i }) => i === elIndex)\r\n    if (item) el = window.document.getElementById(item.id)\r\n    if (!el) el = window.document.createElement(tagName)\r\n  }\r\n\r\n  if (window.isServer && !useSSR) data.append = false\r\n\r\n  elIndex++\r\n\r\n  //data.ssr = useSSR\r\n  data.render = { value, html }\r\n  //el.render = { value, html }\r\n\r\n  el.data = data\r\n\r\n  // Render value to element\r\n  updateEl(el)\r\n\r\n  // Attributes\r\n  Object.keys(attrs).forEach((key) => el.setAttribute(key, attrs[key]))\r\n\r\n  // Classlist\r\n  if (typeof classList === 'string') el.classList.add(classList)\r\n  else if (Array.isArray(classList)) classList.forEach((key) => el.classList.add(key))\r\n\r\n  // Dataset\r\n  Object.keys(dataset).forEach((key) => el.dataset[key] = dataset[key])\r\n\r\n  // Events\r\n  Object.keys(events).forEach((key) => el.addEventListener(key, events[key]))\r\n\r\n  // Attach update keys\r\n  if (updateOn) {\r\n    updater.assign(updateOn, el)\r\n  }\r\n\r\n  return el\r\n}\r\n\r\nexport function newElClass (classList, value, tagName = 'div') {\r\n  return newEl(tagName, { classList, value })\r\n}\r\n\r\nconst valueTags = ['INPUT', 'TEXTAREA']\r\nexport function updateEl (el, newValue) {\r\n  let { value, html } = el.data.render\r\n  if (newValue) value = newValue\r\n  if (!value) return\r\n\r\n  if (typeof value === 'function') {\r\n    const funcValue = value(el)\r\n    if (funcValue) updateEl(el, funcValue)\r\n    return\r\n  }\r\n\r\n  if (valueTags.indexOf(el.tagName) !== -1) {\r\n    el.value = value\r\n    return\r\n  }\r\n\r\n  if (html) {\r\n    el.innerHTML = value\r\n    return\r\n  }\r\n\r\n  el.textContent = value\r\n}","import { updateEl } from './element'\r\n\r\nconst updates = []\r\nconst keys = {}\r\n\r\nexport function assign (key, el) {\r\n  if (Array.isArray(key)) key.forEach((k) => assign(k, el))\r\n  else if (Array.isArray(el)) el.forEach((e) => assign(key, e))\r\n  else updates.push({ key, el })\r\n}\r\n\r\nexport function set (key, updateFunc) {\r\n  keys[key] = { updateFunc }\r\n}\r\n\r\nexport function apply (key, updateFunc) {\r\n  let func = updateFunc\r\n  const update = keys[key]\r\n  if (update) func = update.updateFunc\r\n\r\n  updates.filter((update) => update.key === key).forEach(({ el }) => {\r\n    if (typeof func === 'function') func(el) // custom update\r\n    else updateEl(el) // or use element update\r\n  })\r\n}\r\n","export function replaceStringArgs (str, args) {\r\n  let newStr = str\r\n  Object.keys(args).forEach((key) => {\r\n    let value = ''\r\n    if (typeof args[key] === 'function') value = args[key]()\r\n    else value = args[key]\r\n\r\n    newStr = newStr.replace(`{{${key}}}`, args[key])\r\n  })\r\n  return newStr\r\n}\r\n\r\nexport function applyValue (value, ...args) {\r\n  if (typeof value === 'function') {\r\n    const result = value()\r\n    return applyValue(result, ...args)\r\n  }\r\n  return value\r\n}\r\n\r\nexport function emptyChilds (el) {\r\n  while (el.hasChildNodes()) {\r\n    el.removeChild(el.lastChild)\r\n  }\r\n}\r\n","import { cache } from './fetcher'\r\nimport { newEl, updateEl, ids } from './element'\r\n\r\nconst { Element } = window\r\nconst append = Element.prototype.append\r\nElement.prototype.append = function () {\r\n  append.apply(this, [...arguments].filter((a) => !a.parentElement))\r\n}\r\n\r\nconst appendChilds = Element.prototype.appendChild\r\nElement.prototype.appendChild = function () {\r\n  if (arguments.parentElement) return\r\n  appendChilds.apply(this, arguments)\r\n}\r\n\r\nexport default (options) => {\r\n  const { src, stylesheet, baseUrl = 'http://localhost' } = options\r\n\r\n  const elStyle = newEl('link', {\r\n    attrs: { rel: 'stylesheet', href: stylesheet },\r\n    useSSR: false\r\n  })\r\n\r\n  const elScript = newEl('script', {\r\n    attrs: { src },\r\n    useSSR: false\r\n  })\r\n\r\n  const elSSR = newEl('script', {\r\n    attrs: { type: 'text/javascript' },\r\n    value: `window.__ssr = ${JSON.stringify(ids)}`,\r\n    useSSR: false\r\n  })\r\n\r\n  const elCache = newEl('script', {\r\n    attrs: { type: 'text/javascript' },\r\n    useSSR: false\r\n  })\r\n\r\n  return {\r\n    setUrl: (newUrl) => jsdom.reconfigure({ url: `http://localhost${newUrl}` }),\r\n    toHtml () {\r\n      const { document } = window\r\n      updateEl(elCache, `window.__cache = ${JSON.stringify(cache)}`)\r\n\r\n      console.log(elSSR.parentElement)\r\n      document.head.append(elStyle)\r\n      document.body.append(elSSR, elCache, elScript)\r\n\r\n      return `<!DOCTYPE html>${document.documentElement.outerHTML}`\r\n    }\r\n  }\r\n}\r\n"],"names":["routes","baseUrl","matchPath","p1","p2","Array","isArray","indexOf","apply","currentPath","window","location","pathname","replace","notFound","every","path","forEach","route","element","parent","document","body","append","contains","remove","push","newPath","history","pushState","hashIndex","hash","substring","getElementById","scrollTo","offsetTop","addEventListener","newBaseUrl","el","tagName","href","e","preventDefault","cache","__cache","attachedFetch","defaultRefresh","get","url","func","refresh","Promise","resolve","cacheItem","find","c","Date","now","time","data","fetch","then","res","json","options","index","findIndex","x","splice","fetches","map","all","ids","__ssr","elIndex","newEl","attrs","events","dataset","classList","value","html","updateOn","useSSR","isServer","createElement","id","nanoid","i","item","render","updateEl","Object","keys","key","setAttribute","add","updater","newElClass","valueTags","newValue","innerHTML","textContent","funcValue","updates","assign","k","updateFunc","update","filter","str","args","newStr","applyValue","hasChildNodes","removeChild","lastChild","Element","prototype","this","arguments","a","parentElement","appendChilds","appendChild","src","stylesheet","elStyle","rel","elScript","elSSR","type","JSON","stringify","elCache","setUrl","newUrl","jsdom","reconfigure","toHtml","console","log","head","documentElement","outerHTML"],"mappings":"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"}