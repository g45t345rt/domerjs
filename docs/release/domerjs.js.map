{"version":3,"file":"domerjs.js","sources":["../../src/router.js","../../src/fetcher.js","../../src/element.js","../../src/updater.js","../../src/helpers.js","../../src/ssr.js"],"sourcesContent":["const routes = []\r\n\r\nlet defaultRoot = window.document.body\r\nexport function setRoot (newRoot) {\r\n  defaultRoot = newRoot\r\n}\r\n\r\nfunction updateRoutes (args = { i: 0, routeFound: false, lock: [] }) {\r\n  const root = defaultRoot\r\n  const { i } = args\r\n  if (i > routes.length - 1) return\r\n\r\n  const route = routes[i]\r\n  const { path, el, parent } = route\r\n\r\n  if (path === window.location.pathname || args.updateEmpty) {\r\n    args.routeFound = true\r\n    //args.updateEmpty = false\r\n\r\n    if (!root.isEqualNode(parent)) {\r\n      args.lock.push(parent)\r\n      if (!root.contains(parent)) root.append(parent) //root.appendChild(parent)\r\n    }\r\n\r\n    args.lock.push(el)\r\n    if (!parent.contains(el)) {\r\n      parent.append(el)\r\n      //parent.appendChild(el)\r\n      el.dispatchEvent(new window.Event('routeAttach'))\r\n    }\r\n  } else {\r\n    const isElLock = args.lock.some((l) => el.isEqualNode(l))\r\n    if (!isElLock && parent.contains(el)) {\r\n      //parent.removeChild(el)\r\n      el.remove()\r\n      el.dispatchEvent(new window.Event('routeDetach'))\r\n    }\r\n\r\n    const isParentLock = args.lock.some((l) => parent.isEqualNode(l))\r\n    if (!isParentLock && !root.isEqualNode(parent) && root.contains(parent)) root.removeChild(parent)\r\n  }\r\n\r\n  if (path === '') {\r\n    const nextRoute = routes[i + 1]\r\n    if (nextRoute && nextRoute.path !== '') {\r\n      // make sure empty routes are at the end\r\n      routes.splice(i, 1)\r\n      routes.push(route)\r\n      args.i--\r\n    } else {\r\n      if (!args.routeFound) {\r\n        args.updateEmpty = true\r\n        args.i--\r\n      }\r\n    }\r\n  }\r\n\r\n  args.i++\r\n  updateRoutes(args)\r\n}\r\n\r\nwindow.addEventListener('popstate', function () {\r\n  updateRoutes()\r\n})\r\n\r\nexport function assign (path, el, parent = defaultRoot) {\r\n  if (Array.isArray(path)) {\r\n    path.forEach((p) => assign(p, el, parent))\r\n  } else routes.push({ el, path, parent })\r\n}\r\n\r\nexport function setRouteEl (el, path) {\r\n  if (el.tagName === 'A') el.href = path\r\n  el.addEventListener('click', (e) => {\r\n    e.preventDefault()\r\n    push(path)\r\n  })\r\n  return el\r\n}\r\n\r\nexport function push (path) {\r\n  const basename = '' // TODO later\r\n  const newPath = `${basename}${path}`\r\n\r\n  window.history.pushState({ path: newPath }, '', newPath)\r\n\r\n  // Trigger popstate event to update routes\r\n  //window.dispatchEvent(new Event('popstate'))\r\n  updateRoutes()\r\n\r\n  // Scroll to tag if any \r\n  const hashIndex = path.indexOf('#')\r\n  if (hashIndex !== -1) {\r\n    const hash = path.substring(hashIndex + 1)\r\n    const element = window.document.getElementById(hash)\r\n    if (element) window.scrollTo(0, element.offsetTop)\r\n  }\r\n}\r\n\r\nexport function apply () {\r\n  updateRoutes()\r\n}","export const cache = window.__cache || []\r\nconst attachedFetch = []\r\n\r\nlet defaultRefresh = 100000\r\n\r\nexport function setOptions (options) {\r\n  if (typeof options.refresh === 'number') defaultRefresh = options.refresh\r\n}\r\n\r\nexport function attach (url, func, refresh = defaultRefresh) {\r\n  attachedFetch.push({ url, func, refresh })\r\n}\r\n\r\nexport function detach (url) {\r\n  const index = attachedFetch.findIndex((x) => x.url === url)\r\n  if (index !== -1) attachedFetch.splice(index, 1)\r\n}\r\n\r\nexport function apply () {\r\n  const fetches = attachedFetch.map(({ url, func, refresh }) => get(url, func, refresh))\r\n  return Promise.all(fetches)\r\n}\r\n\r\nexport function get (url, func, refresh = defaultRefresh) {\r\n  return new Promise((resolve) => {\r\n    const cacheItem = cache.find((c) => c.url === url)\r\n    if (cacheItem && Date.now() - refresh < cacheItem.time) {\r\n      resolve(func(cacheItem.data))\r\n      return\r\n    }\r\n  \r\n    fetch(url).then((res) => {\r\n      res.json().then((data) => {\r\n        if (!cacheItem) cache.push({ url, data, time: Date.now() })\r\n        else {\r\n          cacheItem.data = data\r\n          cacheItem.time = Date.now()\r\n        }\r\n  \r\n        resolve(func(data))\r\n      })\r\n    })\r\n  })\r\n}","import { nanoid } from 'nanoid'\r\n\r\nexport let ids = window.__ssr || []\r\n\r\nlet elIndex = 0\r\nexport function newEl (tagName, options = {}) {\r\n  let el = null\r\n  const { attrs = {}, events = {}, dataset = {}, value, html, updateOn, useSSR = true } = options\r\n\r\n  let data = {}\r\n\r\n  if (useSSR && window.isServer) {\r\n    el = window.document.createElement(tagName)\r\n    el.id = nanoid(5)\r\n    ids.push({ id: el.id, i: elIndex })\r\n  } else {\r\n    const item = ids.find(({ i }) => i === elIndex)\r\n    if (item) el = window.document.getElementById(item.id)\r\n    if (!el) el = window.document.createElement(tagName)\r\n  }\r\n\r\n  if (window.isServer && !useSSR) data.append = false\r\n\r\n  elIndex++\r\n\r\n  //data.ssr = useSSR\r\n  data.render = { value, html }\r\n  //el.render = { value, html }\r\n\r\n  el.data = data\r\n\r\n  // Render value to element\r\n  updateEl(el)\r\n\r\n  // Attributes\r\n  Object.keys(attrs).forEach((key) => el.setAttribute(key, attrs[key]))\r\n\r\n  // Dataset\r\n  Object.keys(dataset).forEach((key) => el.dataset[key] = dataset[key])\r\n\r\n  // Events\r\n  Object.keys(events).forEach((key) => el.addEventListener(key, events[key]))\r\n\r\n  // Attach update keys\r\n  if (updateOn) updater.assign(updateOn, el)\r\n\r\n  return el\r\n}\r\n\r\nconst valueTags = ['INPUT', 'TEXTAREA']\r\nexport function updateEl (el, newValue) {\r\n  let { value, html } = el.data.render\r\n  if (newValue) value = newValue\r\n  if (!value) return\r\n\r\n  if (typeof value === 'function') {\r\n    const funcValue = value(el)\r\n    updateEl(el, funcValue)\r\n    return\r\n  }\r\n\r\n  if (valueTags.indexOf(el.tagName) !== -1) {\r\n    el.value = value\r\n    return\r\n  }\r\n\r\n  if (html) {\r\n    el.innerHTML = value\r\n    return\r\n  }\r\n\r\n  el.textContent = value\r\n}","import { updateEl } from './element'\r\n\r\nconst updates = []\r\nconst keys = {}\r\n\r\nexport function assign (key, el) {\r\n  if (Array.isArray(key)) key.forEach((k) => assign(k, el))\r\n  else if (Array.isArray(el)) el.forEach((e) => assign(key, e))\r\n  else updates.push({ key, el })\r\n}\r\n\r\nexport function set (key, updateFunc) {\r\n  keys[key] = { updateFunc }\r\n}\r\n\r\nexport function apply (key, updateFunc) {\r\n  let func = updateFunc\r\n  const update = keys[key]\r\n  if (update) func = update.updateFunc\r\n\r\n  updates.filter((update) => update.key === key).forEach(({ el }) => {\r\n    if (typeof func === 'function') func(el) // custom update\r\n    else updateEl(el) // or use element update\r\n  })\r\n}\r\n","export function replaceStringArgs (str, args) {\r\n  let newStr = str\r\n  Object.keys(args).forEach((key) => {\r\n    let value = ''\r\n    if (typeof args[key] === 'function') value = args[key]()\r\n    else value = args[key]\r\n\r\n    newStr = newStr.replace(`{{${key}}}`, args[key])\r\n  })\r\n  return newStr\r\n}\r\n\r\nexport function applyValue (value, ...args) {\r\n  if (typeof value === 'function') {\r\n    const result = value()\r\n    return applyValue(result, ...args)\r\n  }\r\n  return value\r\n}\r\n\r\nexport function emptyChilds (el) {\r\n  while (el.hasChildNodes()) {\r\n    el.removeChild(el.lastChild)\r\n  }\r\n}\r\n","import { cache } from './fetcher'\r\nimport { newEl, updateEl, ids } from './element'\r\n\r\nconst { Element } = window\r\nconst append = Element.prototype.append\r\nElement.prototype.append = function () {\r\n  append.apply(this, [...arguments].filter((a) => !a.parentElement))\r\n}\r\n\r\nconst appendChilds = Element.prototype.appendChild\r\nElement.prototype.appendChild = function () {\r\n  if (arguments.parentElement) return\r\n  appendChilds.apply(this, arguments)\r\n}\r\n\r\nexport default (options) => {\r\n  const { src, stylesheet, baseUrl = 'http://localhost' } = options\r\n\r\n  const elStyle = newEl('link', {\r\n    attrs: { rel: 'stylesheet', href: stylesheet },\r\n    useSSR: false\r\n  })\r\n\r\n  const elScript = newEl('script', {\r\n    attrs: { src },\r\n    useSSR: false\r\n  })\r\n\r\n  const elSSR = newEl('script', {\r\n    attrs: { type: 'text/javascript' },\r\n    value: `window.__ssr = ${JSON.stringify(ids)}`,\r\n    useSSR: false\r\n  })\r\n\r\n  const elCache = newEl('script', {\r\n    attrs: { type: 'text/javascript' },\r\n    useSSR: false\r\n  })\r\n\r\n  return {\r\n    setUrl: (newUrl) => jsdom.reconfigure({ url: `http://localhost${newUrl}` }),\r\n    toHtml () {\r\n      const { document } = window\r\n      updateEl(elCache, `window.__cache = ${JSON.stringify(cache)}`)\r\n\r\n      console.log(elSSR.parentElement)\r\n      document.head.append(elStyle)\r\n      document.body.append(elSSR, elCache, elScript)\r\n\r\n      return `<!DOCTYPE html>${document.documentElement.outerHTML}`\r\n    }\r\n  }\r\n}\r\n"],"names":["routes","defaultRoot","window","document","body","updateRoutes","args","i","routeFound","lock","root","length","route","path","el","parent","location","pathname","updateEmpty","isEqualNode","push","contains","append","dispatchEvent","Event","some","l","remove","removeChild","nextRoute","splice","newPath","history","pushState","hashIndex","indexOf","hash","substring","element","getElementById","scrollTo","offsetTop","addEventListener","newRoot","assign","Array","isArray","forEach","p","tagName","href","e","preventDefault","cache","__cache","attachedFetch","defaultRefresh","get","url","func","refresh","Promise","resolve","cacheItem","find","c","Date","now","time","data","fetch","then","res","json","options","index","findIndex","x","fetches","map","all","ids","__ssr","elIndex","newEl","attrs","events","dataset","value","html","updateOn","useSSR","isServer","createElement","id","nanoid","item","render","updateEl","Object","keys","key","setAttribute","updater","valueTags","newValue","innerHTML","textContent","updates","k","updateFunc","update","filter","str","newStr","replace","applyValue","result","hasChildNodes","lastChild","Element","prototype","apply","this","arguments","a","parentElement","appendChilds","appendChild","src","elStyle","rel","stylesheet","elScript","elSSR","type","JSON","stringify","elCache","setUrl","newUrl","jsdom","reconfigure","toHtml","console","log","head","documentElement","outerHTML"],"mappings":"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"}